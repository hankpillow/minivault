<html>
	<head>
		<meta charset="utf-8">
		<title>Minivault</title>
		<script>
			const mode = 'AES-GCM';
			const length = 256;
			const	ivLength = 12;

			function fromHexaToUint8Array ( hexString ) {
				return new Uint8Array(hexString.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
			}

			function fromUint8ArrayToHexa (bytes) {
				return bytes.reduce((str, byte) => str + byte.toString(16).padStart(2, '0'), '');
			}

			function fromArrayBufferToHexa (buff) {
				return [].map.call(new Uint8Array(buff), b => ('00' + b.toString(16)).slice(-2)).join('');
			}

			async function genEncryptionKey (password, mode, length) {
				var algo = {
					name: 'PBKDF2',
					hash: 'SHA-256',
					salt: new TextEncoder().encode('minivault'),
					iterations: 1000
				};
				var derived = { name: mode, length: length };
				var encoded = new TextEncoder().encode(password);
				var key = await crypto.subtle.importKey('raw', encoded, { name: 'PBKDF2' }, false, ['deriveKey']);

				return crypto.subtle.deriveKey(algo, key, derived, false, ['encrypt', 'decrypt']);
			}

			// Encrypt function
			async function encrypt (text, password, mode, length, ivLength) {
				var algo = {
					name: mode,
					length: length,
					iv: crypto.getRandomValues(new Uint8Array(ivLength))
				};
				var key = await genEncryptionKey(password, mode, length);
				var encoded = new TextEncoder().encode(text);

				return {
					cipherText: await crypto.subtle.encrypt(algo, key, encoded),
					iv: algo.iv
				};
			}
			async function decrypt (encrypted, password, mode, length) {
				var algo = {
					name: mode,
					length: length,
					iv: encrypted.iv
				};
				var key = await genEncryptionKey(password, mode, length);
				var decrypted = await crypto.subtle.decrypt(algo, key, encrypted.cipherText);
				return new TextDecoder().decode(decrypted);
			}
		</script>
		<style>
		* {
			font-size:1em;
			vertical-align:top;
			font-family:Mono;
		}
		form {
			display:inline-block;
			background-color:lightgray;
			width:320px;
			min-height:230px;
			margin:0;
			padding:10px;
		}
		h1{
			font-size:1.1em
		}
		textarea,
		input[type=text],
		input[type=password]{
			border:0;
			display:block;
			width:100%;
			margin-bottom:15px
		}
		span[name=hash]{
			margin:10 0;
			width:100%;
			word-wrap:anywhere;
			display:block;
			color:darkblue;
		}
		pre[name=secret] {
			width:100%;
			display:block;
			overflow:auto;
			color:darkgreen;
		}
		</style>
	</head>
	<body>
		<h1>ðŸ”’ Minivault</h1>
		<form action="create" method="get">
			<h1>Encrypt</h1>
			<label>Your Secrets:<br>
				<textarea autocomplete="off" required name="secret"   type="text" maxlength="2056" minlength="1" ></textarea>
			</label>
			<label>Password (min 4)<br>
				<input autocomplete="off" required name="password" type="text" maxlength="256"  minlength="4"/>
			</label>
			<input type="submit" value="create"/>
			<span name="hash"></span>
		</form>

		<form action="view" method="get">
			<h1>Decrypt</h1>
			<label>Hash:<br>
				<input required  autocomplete="off" name="hash" type="text" minlength="1" size="16" />
			</label>
			<label>Password (min 4)<br>
				<input required  autocomplete="off" name="password" type="password" minlength="4"/>
			</label>
			<input type="submit" value="view"/>
			<pre name="secret"></pre>
		</form>
		<script>

			document.querySelector("form[action=create]").addEventListener("submit", async event => {
				event.preventDefault()
				const form = event.target
				const secret = form.querySelector("[name=secret]").value.trim()
				const password = form.querySelector("[name=password]").value.trim()
				const encripted = await encrypt(secret, password, mode, length, ivLength)
				const hash = fromUint8ArrayToHexa(encripted.iv) + ";;" +  fromArrayBufferToHexa(encripted.cipherText)
				form.querySelector("[name=hash]").textContent = hash.trim()
				form.reset()
			})

			document.querySelector("form[action=view]").addEventListener("submit", async event => {
				event.preventDefault()
				const form = event.target
				const hash = form.querySelector("[name=hash]").value.trim();
				const parts = hash.split(";;")
				const password = form.querySelector("[name=password]").value.trim()
				try{
					const encripted = {
						iv: fromHexaToUint8Array(parts[0]),
						cipherText: fromHexaToUint8Array(parts[1]),
					}
					const decrypted = await decrypt(encripted, password, mode, length);
					form.querySelector("[name=secret]").textContent = decrypted
				} catch (e) {
					form.querySelector("[name=secret]").textContent = ""
					alert("invalid password")
					console.warn(e)
				}
				form.reset()
			})
		</script>
	</body>
</html>
